name: üöÄ Build & Deploy All Clients

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  pages:
    runs-on: ubuntu-latest
    steps:
      # 1) Checkout code
      - uses: actions/checkout@v4

      # 2) Setup Node.js
      - uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3) Pre-normalize each project for GH Pages subfolders
      #    - Fix index.html to use relative paths
      #    - Ensure vite.config.* has base: '/<slug>/'
      - name: Pre-normalize projects
        shell: bash
        run: |
          set -e
          for dir in project/*/; do
            slug=$(basename "$dir")
            [ "$slug" = "landingpage" ] && continue
            echo "üßπ Normalizing: $slug"

            # A) Make index.html use relative paths
            if [ -f "$dir/index.html" ]; then
              sed -i 's|href="/vite.svg"|href="./vite.svg"|g' "$dir/index.html" || true
              sed -i 's|src="/src/main|src="./src/main|g' "$dir/index.html" || true
            fi

            # B) Ensure vite config has base '/<slug>/'
            cfg="$dir/vite.config.ts"
            [ -f "$dir/vite.config.js" ] && cfg="$dir/vite.config.js"
            if [ ! -f "$cfg" ] || ! grep -q "base: '/$slug/'" "$cfg"; then
              echo "‚úçÔ∏è  Writing vite.config.ts with base '/$slug/'"
              printf "%s\n" \
                "import { defineConfig } from 'vite';" \
                "import react from '@vitejs/plugin-react';" \
                "" \
                "export default defineConfig({" \
                "  plugins: [react()], " \
                "  base: '/$slug/'," \
                "  optimizeDeps: { exclude: ['lucide-react'] }," \
                "});" > "$dir/vite.config.ts"
            fi
          done

      # 4) Normalize routing ‚Üí force HashRouter and strip BrowserRouter (Node-based)
      - name: Normalize routing to HashRouter
        shell: bash
        run: |
          set -e
          cat > normalize-router.mjs <<'JS'
          import { promises as fs } from 'fs';
          import path from 'path';

          const ROOT = process.cwd();
          const PROJECTS = path.join(ROOT, 'project');

          const exists = async p => !!(await fs.stat(p).catch(() => null));
          const findFirst = async (dir, names) => {
            for (const n of names) {
              const p = path.join(dir, n);
              if (await exists(p)) return p;
            }
            return null;
          };

          const ensureHashImport = (src) => {
            if (!/from ['"]react-router-dom['"]/.test(src)) {
              return `import { HashRouter } from 'react-router-dom';\n` + src;
            }
            return src.replace(
              /import\s*\{([^}]*)\}\s*from\s*['"]react-router-dom['"];/,
              (_, list) => {
                const names = list.split(',').map(s => s.trim()).filter(Boolean);
                if (!names.includes('HashRouter')) names.push('HashRouter');
                return `import { ${names.join(', ')} } from 'react-router-dom';`;
              }
            );
          };

          const wrapAppWithHashRouter = (src) => {
            if (/<HashRouter>[\s\S]*<\/HashRouter>/.test(src)) return src;
            return src
              .replace(/<App\s*\/>/, '<HashRouter><App /></HashRouter>')
              .replace(/<App\/>/, '<HashRouter><App /></HashRouter>');
          };

          const stripBrowserRouter = (src) => {
            let out = src.replace(/<BrowserRouter[^>]*>/g, '')
                         .replace(/<\/BrowserRouter>/g, '');
            out = out.replace(
              /import\s*\{([^}]*)\}\s*from\s*['"]react-router-dom['"];/g,
              (_, list) => {
                const names = list.split(',').map(s => s.trim()).filter(n => n && n !== 'BrowserRouter');
                return names.length
                  ? `import { ${names.join(', ')} } from 'react-router-dom';`
                  : '';
              }
            );
            return out;
          };

          const run = async () => {
            const items = await fs.readdir(PROJECTS).catch(() => []);
            for (const slug of items) {
              if (slug === 'landingpage') continue;
              const dir = path.join(PROJECTS, slug);
              const stat = await fs.stat(dir).catch(() => null);
              if (!stat || !stat.isDirectory()) continue;

              const mainPath = await findFirst(dir, ['src/main.tsx','src/main.jsx','src/main.ts','src/main.js']);
              if (mainPath) {
                let src = await fs.readFile(mainPath, 'utf-8');
                const before = src;
                src = ensureHashImport(src);
                src = wrapAppWithHashRouter(src);
                if (src !== before) {
                  await fs.writeFile(mainPath, src, 'utf-8');
                  console.log(`‚úî updated ${path.relative(ROOT, mainPath)}`);
                }
              }

              const appPath = await findFirst(dir, ['src/App.tsx','src/App.jsx','src/App.ts','src/App.js']);
              if (appPath) {
                let src = await fs.readFile(appPath, 'utf-8');
                const out = stripBrowserRouter(src);
                if (out !== src) {
                  await fs.writeFile(appPath, out, 'utf-8');
                  console.log(`‚úî updated ${path.relative(ROOT, appPath)}`);
                }
              }
            }
          };

          run().catch(err => { console.error(err); process.exit(0); });
          JS

          node normalize-router.mjs

      # 5) Build each client demo (skip landingpage)
      - name: Build demos
        shell: bash
        run: |
          set -e
          for dir in project/*/; do
            slug=$(basename "$dir")
            [ "$slug" = "landingpage" ] && continue

            echo "üî® Considering demo: $slug"
            if [ ! -f "$dir/package.json" ]; then
              echo "‚û°Ô∏è  Skipping $slug (no package.json)"
              continue
            fi

            echo "üîß Installing deps for: $slug"
            cd "$dir"
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install --no-audit --no-fund
            fi

            echo "üèó  Building: $slug"
            if npm run -s build; then
              echo "‚úÖ Built with npm run build"
            else
              echo "‚ÑπÔ∏è  Falling back to npx vite build for $slug"
              npx vite build
            fi

            cd ../../

            if [ -d "project/$slug/dist" ]; then
              rm -rf "$slug"
              mkdir -p "$slug"
              cp -r "project/$slug/dist/." "$slug/"
            else
              echo "‚ö†Ô∏è  $slug built but no dist/ found ‚Äî skipping copy"
            fi
          done

      # 6) Build & copy landing page into root
      - name: Build landing page
        shell: bash
        run: |
          cd project/landingpage
          npm ci
          npm run build
          cd ../../
          cp -r project/landingpage/dist/* .

      # 7) Dynamic SPA fallback for ALL paths (single-line echo; no template strings)
      - name: Create smart 404.html
        shell: bash
        run: |
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Redirecting</title></head><body><script>var p=location.pathname.split("/").filter(Boolean);if(p.length>0){var s=p[0];var r=p.slice(1).join("/");var h=r?"#/"+r:"";window.location.replace("/"+s+"/index.html"+h);}else{window.location.replace("/index.html");}</script><p>Redirecting...</p></body></html>' > 404.html

      # 8) Debug: list everything that will be published
      - name: Show publish directory
        shell: bash
        run: |
          echo "=== publish contents ==="
          ls -R .
          echo "========================"

      # 9) Deploy to GitHub Pages (gh-pages branch)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./
